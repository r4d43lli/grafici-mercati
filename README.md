Progetto individuale informatica
Matteo Radaelli
OBBIETTIVO DEL PROGETTO:
Creazione di grafici dei titoli azionari (ticker) più attivi in modo automatico, ricavando l’elenco dei titoli tramite il web scraping e i dati storici dal sito “Yahoo Finance” tramite la libreria yfinance.
SCELTE PROGETTUALI:
Come primo approccio ho deciso di usare il web scraping per selezionare i ticker che si vogliono analizzare. In seguito, attraverso la libreria Yahoo Finance ho scaricato i dati storici di ogni ticker e infine ho creato i grafici utilizzando la libreria matplotlib. L’altra opzione per creare il grafico a candela era quella di usare un'altra libreria aggiuntiva (mplfinance.original_flavor), ma ho ritenuto più semplice creare il grafico senza l’aiuto di essa. La parte finale è stata quella di salvare i grafici in PNG e inserirli in una cartella. Un’altra soluzione sarebbe stata quella di creare un file PDF con dentro tutti i grafici, ma l’ho ritenuta troppo complessa e, in generale, è comunque facile accedere ai grafici tramite PNG.
STRUTTURA DEL CODICE E FUNZIONAMENTO:
Il codice si struttura in 3 parti principali: la prima consiste nel trovare i dati di un URL che visualizzi un elenco di ticker utilizzando il web scraping, la seconda consiste nello scaricare i dati dal sito e salvarli in un file CSV, infine nella terza si crea e si salva il grafico a candele in formato PNG. 
Nel codice sono state utilizzate un totale di 8 librerie: BeautifulSoup per analizzare l’HTML, requests per fare richieste HTTP, pandas per gestire i dati tabulari, yfinance per scaricare i dati finanziari, datetime e timedelta per gestire le date, os per gestire i file del sistema.
La prima parte del codice è dove viene fatto il setup delle cartelle. In primis si ottiene il percorso della cartella dove si trova il codice, poi si crea un percorso per il file CSV e un altro percorso per la cartella dei grafici, sempre utilizzando la libreria os con il metodo os.path.join. Infine, si dice al programma di non fare nulla se la cartella esiste già.
Dalla prossima riga parte il web scraping, sfruttando la libreria BeautifulSoup e requests, che ci permettono di leggere le informazioni del sito e ricavare i dati. Si indica l’URL della pagina interessata, come opzione di default ho inserito gli indici più attivi di Yahoo Finance, ma si possono inserire diversi Url purché contengano una tabella con gli indici, altrimenti il programma da errore e si ferma. È importante che l’Url sia di Yahoo Finance perché sennò risulterebbe impossibile scaricare i dati visto che si usa la libreria yfinance quindi per esempio inserendo un Url di Google Finance il programma mostra errore di Url non valido. Prima di ricavare qualsiasi dato, si imposta l’intestazione della richiesta di pagina web come se un umano stesse facendo una ricerca, per evitare eventuali blocchi da parte del sito. In seguito, si inizia ad analizzare il codice HTML per trovare dove sono inserite le informazioni necessarie (in questo caso dove si trovano i ticker nel codice html) facendo appunto lo scraping del sito, in poche parole “leggere come farebbe un umano l’elenco dei ticker nella pagina”. In seguito, si trasforma da formato HTML ad un formato leggibile dal programma. Quindi si cerca il primo tag <table> nella pagina. In questo momento inizia l’estrazione dei ticker, inseriti in una lista vuota. Si comincia cercando il tag HTML <tbody> dentro la tabella, perché è la parte contenente i dati che ci servono. Inoltre ricaviamo tutti i tag <tr> che rappresentano le righe della tabella. Con il ciclo for troviamo tutte le celle con dentro i dati per ogni riga. La prima cella (celle[0]) contiene il nome del ticker, che viene estratto sotto forma di testo rimuovendo i tag HTML. Per evitare problemi, vengono rimossi gli spazi bianchi con il metodo strip e infine si aggiunge il ticker alla lista, creando una lista con tutti i ticker trovati.
Decidiamo un intervallo temporale, in questo caso di un anno; di conseguenza prenderemo tutti i dati dal giorno odierno a un anno prima. Passando alle prossime righe, iniziamo a preparare il download per i ticker creando una lista vuota per mettere tutti i DataFrame e un’altra con le colonne necessarie per creare i grafici. Grazie a questo possiamo scaricare i dati storici da Yahoo Finance, con ‘ticker’ che rappresenta il simbolo dell’azione, ‘start’ che equivale alla data di inizio, ‘strftime’ che formatta la data come “anno-mese-giorno”, ‘end’ che significa la data di fine e infine progress=False che nasconde la barra di progresso. Il risultato finale è un DataFrame, che sarebbe come una tabella Excel ma per Python, utilizzata nella libreria pandas.
Un problema che si viene a creare utilizzando la libreria yfinance è quello delle cosiddette colonne Multilivello. Quando scarichiamo i DataFrame, yfinance alcune volte non crea una stringa singola che indica ad esempio il prezzo di apertura, ma crea una tupla mettendo insieme anche il nome del ticker quindi nel download avremo ad esempio  [‘Open’, ‘Nvdia’]. Ciò crea problemi per la creazione dei grafici quindi nel codice controlliamo se le colonne sono multilivello. Nel caso il controllo, tramite isinstance, rilevi che la colonna è un indice multiplo, e quindi restituisca True, la colonna viene “appiattita” estraendo il primo indice e non il ticker, che risulterebbe in una serie di dati vuoti, così si ha una stringa semplice e non una tupla che risulterebbe complessa da utilizzare per la creazione dei grafici o porterebbe alla creazione di grafici vuoti.
Passiamo alla parte di trasformazione da DataFrame a valori numerici: facciamo un ciclo for e per ogni colonna trasformiamo i valori in numeri. È importante specificare che se non viene trovato un valore valido, ad esempio perché il valore arrivato è una stringa, il dato viene trasformato in NaN (Not a Number) per evitare errori. Di conseguenza vengono rimosse le righe con valori NaN usando il metodo dropna della libreria pandas, che significa proprio “eliminare ciò che contiene NaN”. Questo viene fatto per non avere dati mancanti ed evitare la creazione di grafici con righe vuote, problema che si presentava nelle versioni iniziali del codice.
Infine uniamo tutti i dati concatenandoli uno sotto l’altro, creando un nuovo indice progressivo, e convertiamo la colonna delle date nel tipo datetime64, cambiando i valori delle date da stringhe a date per poterci lavorare in matplotlib. Quindi salviamo i tutto in un file CSV per poterli utilizzare dopo per creare i grafici.
Passando alla parte finale del codice, creiamo un ciclo for per ogni ticker contenuto nel file CSV usando il metodo unique di pandas, che evita di prendere ticker duplicati. La riga successiva serve per selezionare solo i dati che appartengono al ticker in elaborazione; si crea un filtro che vale True solo per le righe dove il ticker corrisponde e nella riga sotto si ordinano le righe per data dalla più vecchia alla più recente, per creare il grafico in modo cronologico.
Passiamo alla parte della creazione del grafico, creando la figura, quindi il grafico stesso e l’asse, definendo le dimensioni in pollici. Poi si determinano i colori, che cambiano in base al fatto che il prezzo di chiusura sia minore o maggiore del prezzo di apertura, variando dal verde al rosso. Zip serve a unire due colonne insieme, dove poi faremo il confronto per decidere il colore finale. Infine creiamo un ciclo for che prende, per ogni giorno di borsa, la data, il prezzo di apertura, il massimo, il minimo, il prezzo di chiusura e il colore della candela, usando sempre zip. Inoltre si utilizza enumerate per dare un indice, evitando di usare range(len), che risulterebbe più lungo e meno chiaro.
Infine creiamo il titolo, le etichette per l’asse orizzontale e verticale, formattiamo automaticamente le date sull’asse x, le ruotiamo leggermente ed evitiamo che si sovrappongano rendendo il grafico illeggibile. Per evitare sovrapposizioni, layout sbagliati e rendere tutto più leggibile si utilizza tight_layout. In conclusione salviamo l’immagine nella cartella apposita come PNG con risoluzione 100 dpi e con bbox_inches='tight' eliminiamo i margini bianchi extra. Come ultimo passo chiudiamo la figura e liberiamo la memoria per evitare che si apra per ogni ticker una nuova pagina con il grafico.
DIFFICOLTÀ E SOLUZIONI ADOTTATE
La prima difficoltà è stata quella di dover capire come funzionava il web scraping, un metodo per ricavare i dati dal web che non avevo mai utilizzato. Ho dovuto imparare da zero non avendo una base su questo metodo, cercando su internet tutorial e chiedendo all’AI. Un altro problema era scaricare i dati e renderli leggibili, un problema che non sapevo come risolvere usando lo stesso metodo di prima e quindi cercando su internet e con l’aiuto dell’AI ho adottato l’utilizzo della libreria dedicata. Dopo aver capito come funzionasse, ho dovuto creare grafici con matplotlib, libreria che non avevo mai usato e anche lì ho dovuto imparare da zero seguendo tutorial. Un altro problema che ho riscontrato e che mi ha portato via molto tempo è stato quello delle colonne multilivello di Yahoo e della cancellazione delle righe con valori NaN; infatti nel codice iniziale mi creava grafici vuoti con date del 1969, il che equivaleva a un errore.
RISULTATI OTTENUTI E ESEMPI DI UTILIZZO
Con questo codice possiamo ottenere l’andamento dei titoli più attivi nell’ultimo anno, riuscendo a vedere dei trend e prevedere gli andamenti di mercato nel futuro. Può essere utilizzato per ogni tipo di azione, non solo quelle più utilizzate, ma anche, per esempio, azioni di una nazione specifica oppure un altro esempio i titoli più volatili. Inoltre posiamo modificare l’intervallo di tempo in base alle nostre esigenze: possiamo creare il grafico ad esempio con un intervallo di tempo minore o maggiore come un mese o 10 anni.


